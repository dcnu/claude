#!/bin/bash
# Detect project type and extract metadata for README generation
# Outputs JSON to stdout

set -e

# Initialize defaults
TYPE="unknown"
NAME=""
VERSION=""
DESCRIPTION=""
PACKAGE_MANAGER="unknown"
FRAMEWORK="none"
DATABASE="none"
HAS_TESTS=false
TEST_COMMAND=""
HAS_PRISMA=false
HAS_ENV_EXAMPLE=false

# Check for Node.js project
if [[ -f "package.json" ]]; then
	TYPE="node"
	NAME=$(jq -r '.name // ""' package.json 2>/dev/null || echo "")
	VERSION=$(jq -r '.version // ""' package.json 2>/dev/null || echo "")
	DESCRIPTION=$(jq -r '.description // ""' package.json 2>/dev/null || echo "")

	# Detect package manager
	if [[ -f "pnpm-lock.yaml" ]]; then
		PACKAGE_MANAGER="pnpm"
	elif [[ -f "yarn.lock" ]]; then
		PACKAGE_MANAGER="yarn"
	elif [[ -f "package-lock.json" ]]; then
		PACKAGE_MANAGER="npm"
	else
		PACKAGE_MANAGER="pnpm"  # Default per CLAUDE.md
	fi

	# Detect framework
	if [[ -f "next.config.js" ]] || [[ -f "next.config.ts" ]] || [[ -f "next.config.mjs" ]]; then
		TYPE="nextjs"
		FRAMEWORK="next"
	elif jq -e '.dependencies.express' package.json >/dev/null 2>&1; then
		FRAMEWORK="express"
	elif jq -e '.dependencies.fastify' package.json >/dev/null 2>&1; then
		FRAMEWORK="fastify"
	fi

	# Detect database
	if jq -e '.dependencies["@prisma/client"]' package.json >/dev/null 2>&1; then
		DATABASE="postgresql"
		HAS_PRISMA=true
	elif jq -e '.dependencies.pg' package.json >/dev/null 2>&1; then
		DATABASE="postgresql"
	elif jq -e '.dependencies.mysql2' package.json >/dev/null 2>&1; then
		DATABASE="mysql"
	elif jq -e '.dependencies.mongodb' package.json >/dev/null 2>&1; then
		DATABASE="mongodb"
	fi

	# Check for tests
	if jq -e '.scripts.test' package.json >/dev/null 2>&1; then
		HAS_TESTS=true
		TEST_COMMAND="${PACKAGE_MANAGER} test"
	fi

# Check for Python project
elif [[ -f "pyproject.toml" ]]; then
	TYPE="python"
	NAME=$(grep -E '^name\s*=' pyproject.toml | head -1 | sed 's/.*=\s*"\(.*\)"/\1/' 2>/dev/null || echo "")
	VERSION=$(grep -E '^version\s*=' pyproject.toml | head -1 | sed 's/.*=\s*"\(.*\)"/\1/' 2>/dev/null || echo "")
	DESCRIPTION=$(grep -E '^description\s*=' pyproject.toml | head -1 | sed 's/.*=\s*"\(.*\)"/\1/' 2>/dev/null || echo "")

	# Detect package manager
	if [[ -f "uv.lock" ]] || [[ -f ".python-version" ]]; then
		PACKAGE_MANAGER="uv"
	elif [[ -f "requirements.txt" ]]; then
		PACKAGE_MANAGER="uv"  # Default per CLAUDE.md
	else
		PACKAGE_MANAGER="uv"
	fi

	# Detect framework
	if grep -q "fastapi" pyproject.toml 2>/dev/null; then
		FRAMEWORK="fastapi"
	elif grep -q "flask" pyproject.toml 2>/dev/null; then
		FRAMEWORK="flask"
	elif grep -q "django" pyproject.toml 2>/dev/null; then
		FRAMEWORK="django"
	fi

	# Check for tests
	if [[ -d "tests" ]] || [[ -d "test" ]]; then
		HAS_TESTS=true
		TEST_COMMAND="pytest"
	fi

elif [[ -f "requirements.txt" ]]; then
	TYPE="python"
	PACKAGE_MANAGER="uv"

	if grep -q "fastapi" requirements.txt 2>/dev/null; then
		FRAMEWORK="fastapi"
	elif grep -q "flask" requirements.txt 2>/dev/null; then
		FRAMEWORK="flask"
	elif grep -q "django" requirements.txt 2>/dev/null; then
		FRAMEWORK="django"
	fi

	if [[ -d "tests" ]] || [[ -d "test" ]]; then
		HAS_TESTS=true
		TEST_COMMAND="pytest"
	fi
fi

# Check for Prisma
if [[ -d "prisma" ]]; then
	HAS_PRISMA=true
fi

# Check for .env.example
if [[ -f ".env.example" ]]; then
	HAS_ENV_EXAMPLE=true
fi

# Check for README
README_EXISTS=false
if [[ -f "README.md" ]] || [[ -f "readme.md" ]] || [[ -f "README" ]]; then
	README_EXISTS=true
fi

# Get last commit that touched README
LAST_README_COMMIT=""
if [[ "$README_EXISTS" == "true" ]] && [[ -d ".git" ]]; then
	README_FILE="README.md"
	if [[ -f "readme.md" ]]; then
		README_FILE="readme.md"
	elif [[ -f "README" ]]; then
		README_FILE="README"
	fi
	LAST_README_COMMIT=$(git log -1 --format="%H" -- "$README_FILE" 2>/dev/null || echo "")
fi

# Get project name from directory if not found
if [[ -z "$NAME" ]]; then
	NAME=$(basename "$(pwd)")
fi

# Output JSON
cat <<EOF
{
  "type": "$TYPE",
  "name": "$NAME",
  "version": "$VERSION",
  "description": "$DESCRIPTION",
  "packageManager": "$PACKAGE_MANAGER",
  "framework": "$FRAMEWORK",
  "database": "$DATABASE",
  "hasTests": $HAS_TESTS,
  "testCommand": "$TEST_COMMAND",
  "hasPrisma": $HAS_PRISMA,
  "hasEnvExample": $HAS_ENV_EXAMPLE,
  "readmeExists": $README_EXISTS,
  "lastReadmeCommit": "$LAST_README_COMMIT"
}
EOF
